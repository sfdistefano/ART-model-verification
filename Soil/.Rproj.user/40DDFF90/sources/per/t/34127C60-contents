library("tidyverse")
library("soiltexture")
library("qdapRegex")

setwd("C:/Users/sfper/Documents/R/WRFO_git/Soil")

#### IMPORT ####
# depth to bedrock
art.depth <- read.csv("ART.plot.depth.csv")
# field measurements: rock fragment%, horizon depths
art.field <- read.csv("ART.soil.field.csv")
# particle size analysis: sand%, clay%, silt%
art.psa <- read.csv("ART.soil.PSA.csv")
# combining site name and plot number into one column called "Plot"
art.psa <- unite(art.psa, col="Plot", 1:2, sep=" ")
# renaming columns so that particle size %s are capitalized (required format for later function)
colnames(art.psa) <- c("Plot", "Horizon", "sample.wt.g", "SAND", "CLAY", "SILT")


#### CALCULATING CLAY by WEIGHT ####
# removing white space so that the data aggregates to the correct number of plots
art.psa$Plot <- rm_white(art.psa$Plot)
# summing all the sample weights (g) from each horizon into a total sample weight from each soil pit
total.samp.wt <- aggregate(data = art.psa, sample.wt.g ~ Plot, sum)
# renaming columns to not mix them up later
colnames(total.samp.wt) <- c("Plot", "total.samp.wt")
# adding total weight to the dataset to later calculate clay by weight %
art.psa <- merge(art.psa, total.samp.wt, by = "Plot")
# weighting clay %s for each horizon by their depth (cm) within the soil pit
art.psa$samp.wt.clay <- (art.psa$sample.wt.g * art.psa$CLAY)/art.psa$total.samp.wt
# renaming Plot names so I don't have multiples on one plot when data is aggregated
art.psa$Plot <- gsub(pattern = "Fed 30-16", replacement = "Federal 30-16", x = art.psa$Plot)
# summing the clay %s of each horizon within a plot
total.clay.wt <- aggregate(data = art.psa, samp.wt.clay ~ Plot, sum)
colnames(total.clay.wt) <- c("Plot", "total.clay.wt")

#### CALCULTING SAND % BY WEIGHT ####
# weighting clay %s for each horizon by their depth (cm) within the soil pit
art.psa$samp.wt.sand <- (art.psa$sample.wt.g * art.psa$SAND)/art.psa$total.samp.wt

# summing the clay %s of each horizon within a plot
total.sand.wt <- aggregate(data = art.psa, samp.wt.sand ~ Plot, sum)

colnames(total.sand.wt) <- c("Plot", "total.sand.wt")

#### CALCULATING ROCK % by VOLUME ####
# removing text within Plot names to prepare for merging later
art.field$Plot <- gsub(pattern = "FR|Well Pad", replacement = "", x = art.field$Plot)
# renaming one plot name so it matches others
art.field$Plot <- gsub(pattern = "Fed 30-16", replacement = "Federal 30-16", x = art.field$Plot)
art.psa$Plot <- gsub(pattern = "Fed 30-16", replacement = "Federal 30-16", x = art.psa$Plot)
# previous removal of text leaves extra white space, getting rid of said white space
art.field$Plot <- rm_white(art.field$Plot)
art.psa$Plot <- rm_white(art.psa$Plot)
# adding soil pit depth from field data
art.soil <- merge(art.psa, art.field, by = c("Plot", "Horizon"))
# removing unnecessary characters from plot names
art.depth$Plot <- gsub(pattern = "FR|Well Pad", replacement = "", x = art.depth$Plot)
# removing additional white space
art.depth$Plot <- rm_white(art.depth$Plot)
# combining all info needed to calculate rock % by volume 
art.final <- merge(art.soil, art.depth, by = c("Site", "Plot"))
# renaming column so that it's shorter and less confusing
names(art.final)[names(art.final) == 'Total.Rock.Fragments..vol.'] <- 'hor.rock'
# calculating total (cm) depth of horizons
art.final$hor.depth <- (art.final$Lower.Depth - art.final$Upper.Depth)
# weighting rock % by how much space it took up in the pit
art.final$hor.rock.vol <- (art.final$hor.rock * art.final$hor.depth)/art.final$Total.Soil.Pedon.Depth
# summing all rock %s from all horizons in each plot
total.rock.vol <- aggregate(data = art.final, hor.rock.vol ~ Plot, sum)
# renaming columns to make less confusing
colnames(total.rock.vol) <- c("Plot", "tot.rock.vol")

#### FINAL DATASET for PSC CALCULATION ####
psc <- merge(total.clay.wt, total.rock.vol, by = "Plot")

write.csv(psc, "psc.data.csv")

